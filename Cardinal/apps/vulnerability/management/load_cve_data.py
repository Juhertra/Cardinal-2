import os
import json
from django.core.management.base import BaseCommand
from apps.report.models import Vulnerability


class Command(BaseCommand):
    
    help = 'Loads CVE data into the database'

    def handle(self, *args, **options):
        # Path to the directory containing the NVD and CVE files
        base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        data_dir = os.path.join(base_dir, 'cve/data')


        for filename in os.listdir(data_dir):
            if filename.endswith('.json'):
                with open(os.path.join(data_dir, filename)) as f:
                    cve_data = json.load(f)

                for cve_item in cve_data['CVE_Items']:
                    # Extract relevant fields from the CVE data
                    cve_id = cve_item['cve']['CVE_data_meta']['ID']
                    summary = cve_item['cve']['description']['description_data'][0]['value']
                    severity = cve_item['impact']['baseMetricV3']['cvssV3']['baseSeverity']

                    # Check if the CVE already exists in the database
                    if not Vulnerability.objects.filter(cve_id=cve_id).exists():
                        # Create a new Vulnerability object for the CVE
                        Vulnerability.objects.create(
                            cve_id=cve_id,
                            summary=summary,
                            severity=severity
                        )

        self.stdout.write(self.style.SUCCESS('CVE data loaded successfully'))
